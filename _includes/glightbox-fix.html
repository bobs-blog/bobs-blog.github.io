<!-- GLightbox Close Fix -->
<script>
  (function () {
    function fixGLightboxClose() {
      // Add click handler for backdrop and close button
      document.addEventListener(
        "click",
        function (e) {
          const container = document.querySelector(".glightbox-container");
          if (!container) return;

          // Check if lightbox is visible
          const isVisible =
            container.offsetParent !== null &&
            !container.classList.contains("glightbox-hide") &&
            window.getComputedStyle(container).display !== "none";

          if (!isVisible) return;

          // Close on backdrop click (clicking the container itself, not the image)
          if (
            e.target === container ||
            (e.target.classList.contains("glightbox-container") &&
              !e.target.closest(".gslide") &&
              !e.target.closest(".gslide-media"))
          ) {
            e.preventDefault();
            e.stopPropagation();
            if (
              window.glightboxInstance &&
              typeof window.glightboxInstance.close === "function"
            ) {
              window.glightboxInstance.close();
            } else if (typeof GLightbox !== "undefined") {
              // Try to find and close any open GLightbox instance
              const instances = document.querySelectorAll(
                ".glightbox-container"
              );
              instances.forEach(function (inst) {
                if (inst.offsetParent !== null) {
                  inst.style.display = "none";
                  document.body.style.overflow = "";
                }
              });
            }
            return false;
          }

          // Close button click
          if (
            e.target.classList.contains("gbtn-close") ||
            e.target.closest(".gbtn-close") ||
            e.target.classList.contains("glightbox-close") ||
            e.target.closest(".glightbox-close")
          ) {
            e.preventDefault();
            e.stopPropagation();
            if (
              window.glightboxInstance &&
              typeof window.glightboxInstance.close === "function"
            ) {
              window.glightboxInstance.close();
            } else {
              container.style.display = "none";
              document.body.style.overflow = "";
            }
            return false;
          }
        },
        true
      ); // Use capture phase

      // ESC key handler
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" || e.keyCode === 27) {
          const container = document.querySelector(".glightbox-container");
          if (container && container.offsetParent !== null) {
            if (
              window.glightboxInstance &&
              typeof window.glightboxInstance.close === "function"
            ) {
              window.glightboxInstance.close();
            } else {
              container.style.display = "none";
              document.body.style.overflow = "";
            }
          }
        }
      });
    }

    // Try multiple times to ensure it runs after GLightbox is loaded
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", fixGLightboxClose);
    } else {
      fixGLightboxClose();
    }

    window.addEventListener("load", function () {
      setTimeout(fixGLightboxClose, 100);
      setTimeout(fixGLightboxClose, 500);
    });
  })();
</script>
